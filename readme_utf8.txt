パケットエラー測定ツール (v2.06-1)
　　　　　　　　　　　　　　　　　　　　　　　モノワイヤレス株式会社 2015/10/21

*** 本ドキュメントは等幅フォントで参照ください ***

1. はじめに
　本ツールは、無線ノード間のパケットエラー率を測定する測定を目的とします。パケッ
トエラー率 (PER: Packet Error Rate) は、測定端から他の測定端へパケットを送信する
とき、どれくらいの割合で送信が成功するかで定義されます。

2. 利用条件
　本ツールはモノワイヤレス株式会社の著作物です。提供されるバイナリ、ソースコード、資料
は TWE (The WIRELESS ENGINE) シリーズにのみ利用できます。
　本ツールは無保証です。不具合等が発見された場合はモノワイヤレス株式会社サポート宛に報
告をお願い致します。ただし報告された不具合等の修正を約束するものではありません。

3. 使用方法
3.1 インストール
・無線センサーノード(液晶付き), 無線センサーノード(液晶無し) を各１台用意します。
・無線センサーノード(液晶付き)には PER_Master_JN51xx_yy.bin (xx はチップモデル
　yy はバージョン番号) を書き込みます。以下 Master と呼びます。
・無線センサーノード(液晶無し)には PER_Slave_JN51xx_yy.bin (xx はチップモデル
　yy はバージョン番号) を書き込みます。以下 Slave と呼びます。

3.2 電源投入
 (1) Slave 側の電源を投入します。
→ 電源投入後 LED2 が１秒おきに点滅します。

※ Master/Slave と試験可能なのは 1:1 のペアで、複数台の子機を同時に電源を
   投入する必要はありません。手順 (2) では、複数台の子機が存在するときに
   特定の１台を選択するようになっていますが、原則としてはSlave１台のみ電源
   を投入しいます。

 (2) Master 側の電源を投入します。
→ 以下の画面が表示されます。
+---------+---------+---------+--+
|Wait a minute                   |
...
のメッセージの数秒後、以下のような画面が表示されます。
+---------+---------+---------+--+
|<              PER x.yy-z >     | バージョン番号
|Choose PER desitination         |
|1: 0700e1e, 0e1f, Ch:18 Lq:138  | Slave側のシリアル番号, アドレス
|2: -- not available --          |    チャネル、LQI を表示。
|3: -- not available --          | 2,3,4 は複数のSlaveが存在する場合に表示
|4: -- not available --          |
|                                |
+--------------------------------+
|   1       -       -      -     | 反転表示。主にボタンの割当を表示
+---------+---------+---------+--+
   ↑SW1   ↑SW2   ↑SW3   ↑SW4   ボタンの対応

→ Slaveが電源投入されていない場合は、以下のようなメッセージが表示されます。
　SW4 を押してもう一度Slaveとの通信を試みるか、Masterの電源を再投入してください。
...
|Child not found. Try Rescan     |
+--------------------------------+
|                        <Rescan |
+---------+---------+---------+--+

※ 通常は、試験対象Slaveのみ電源投入して、Master/Slave を近くに置いて試験を開始
   します。
※ ４台分必ずリストされるわけではありません。複数台の電源が入っている場合は、
   試験対象のSlaveのみの電源を投入してください。

 (3) Master 側で SW1 を押して Slave側を選択します。
     (複数のSlaveから選択する場合は SW2-SW4 を押します)
→ 以下の画面が表示されます。
+--------------------------------+
|<              PER x.yy-z >     | バージョン番号
|Channel* 18 ###.......# |0700e1e| チャネル, エナジー |Slaveシリアル
|Payload* 32 byte        |Sh=0e1f| ペイロードサイズ   |Slaveアドレス
|Tick   : 20 ms                  | 送信間隔 (ms)
|Count  : 1000                   | 送信回数
|Retry  : 3                      | 再送回数
|AppAck : No | Pwr: 3            | AppAck モード, 出力
+--------------------------------+
| Next>   ChDn     ChUp   !Start | ボタン割当
+--------------------------------+
   ↑SW1   ↑SW2   ↑SW3   ↑SW4

　画面上では、各設定が表示されています。
　・Channel などの設定文字の後に * か : が表示されますが、* は、
　　SW2-4で操作可能な設定である事を示します。
　・Channel は測定しようとするチャネル (11-25)
　　右側のバーグラフは設定しようとするチャネルのエナジーレベルを示し、バーが
　　長くなるほどノイズの多いチャネルです。
　・Payload は送信するデータサイズ (4-108)
　・Tick は送信間隔 (5-100)
　　再送で送信完了まで時間がかかった場合、設定より時間がかかる場合があります。
　・Count は送信回数 (100-10000)
　・Retry は 802.15.4 MAC 層で行われる再送回数 (0-7)
　・AppAck は Salve側が受信後、受信されたパケットと同内容のパケットを返信します。
　　再送回数、ペイロードサイズは Master 側と同設定となります。
　　Tick は 20ms 以上を推奨します。Master側の次の送信と、Slave側の送信がぶつかり
　　送受信の成功率が下がったり全く通信できなくなる場合があります。

　本画面では、以下の操作が可能です。
　・SW1(Next>) : 次の設定画面へ
　・SW2(ChDn)  : チャネルを一つ下げる
　・SW3(ChUp)  : チャネルを一つ上げる
　・SW4(!Start): 現在の設定でエラー率測定を行います

 (4) SW1 (Next>) を選択する事で、次の設定画面に遷移します。
→ 以下の画面が表示されます。
...
| Next>   Payld    Tick    Count | ボタン割当
+--------------------------------+
   ↑SW1   ↑SW2   ↑SW3   ↑SW4

　本画面では、以下の操作が可能です。
　・SW1(Next>): 次の設定画面へ
　・SW2(Payld): ペイロードサイズを変更する
　・SW3(Tick) : 送信間隔を変更する
　・SW4(Count): 送信回数を変更する

 (5) SW1 (Next>) を選択する事で、次の設定画面に遷移します。
→ 以下の画面が表示されます。
...
| Next>   Retry    AppAck  Power | ボタン割当
+--------------------------------+
   ↑SW1   ↑SW2   ↑SW3   ↑SW4

　本画面では、以下の操作が可能です。
　・SW1(<Back)  : 最初の設定画面へ
　・SW2(Retry)  : MAC 再送回数の設定
　・SW3(AppAck) : Application Ack (往復送受信) の設定
　・SW4(<Reconf): 出力の切り替え (0:最弱 3:標準)

 (6) SW1 (Start>) を選択する事で、エラー率測定を開始します。
→ Wait a minute. が表示され、以下の画面が表示されます。
　 (Slave側との通信に失敗した場合は SW4 により再接続を行ってください)

AppAck = No の場合、
+--------------------------------+
|<              PER x.yy-z >     | バージョン番号
|Progrs:    55/100       |0700e1e| 送信数/送信回数 |Slaveシリアル
|MacAck:    55           |Sh=0e1f| 送信成功数      |Slaveアドレス
|Error :   0.0% |Ch=18 Rt=3 Po=3 | エラー率   | チャネル、再送、出力(3:最大固定)
|　             |Py=4 Ti=5       |            | ペイロード、送信間隔設定表示
|                                |
|　                              |
+--------------------------------+
|  55% #####.....#          Stop | 進捗バーグラフ
+--------------------------------+
AppAck = Yes の場合、
+--------------------------------+
|<              PER x.yy-z >     | バージョン番号
|Progrs:    55/100       |0700e1e| 送信数/送信回数 |Slaveシリアル
|MacAck:    55           |Sh=0e1f| 送信成功回数    |Slaveアドレス
|Error :   0.0% |Ch=18 Rt=3 Po=3 | エラー率   | チャネル、再送、出力(3:最大固定)
|AppAck:    55  |Py=4 Ti=50      | 受信成功数 | ペイロード、送信間隔設定表示
|Error :   0.0%                  | エラー率(受信)
|LQI   :   101  #######.........#| LQI(受信品質の平均値) と LQI のバーグラフ(瞬間値)
+--------------------------------+
|  55% #####.....#          Stop | 進捗バーグラフ
+--------------------------------+

　測定中は SW4(Stop) により、測定を中断できます。

→ 測定が完了すると、ボタン割当が以下に変化します。
   同時にエラー率とそれに応じたメッセージが表示されます。
...
| <Back  0% PERFECT       Start! | ボタン割当
+--------------------------------+

　本画面では、以下の操作が可能です。
　・SW1(<Back)  : 設定画面に戻る
　・SW2()       : 割当無し
　・SW3()       : 割当無し
　・SW4(!Start) : Slaveの再接続を行わず、現在の設定で再測定する

  エラー率のメッセージは以下になります。
      ～ 2% PERFECT
     2～ 5% EXCELLENT
     5～15% FINE
    15～30% GOOD
    30～50% FAIR
    50～80% POOR
    80～99% VeryPOOR
       100% HOPELESS

4. その他
・測定開始までにMaster側とSlave側との設定のための通信を行います。エラーが頻発す
　る環境で設定のための通信は困難となります。
　これを回避するため、
   (1) Master/Slave を極近くで、所望の設定を行った上で測定を行っておく
   (2) Master/Slave の＜電源をそのまま、設定を変更せず＞測定地点まで移動する
   (3) 再測定により測定を行う
  ※ Payload/Tick/Count 設定は変更しても再接続は行いません。

5. 制限事項
・モノワイヤレス株式会社は、測定結果の正確性を保証するものではありません。
・複数の同ツールが同一電波範囲内に存在した場合は、パケットが混信する場合がありま
　す。同一チャネル内でSlave側を複数ノード動作させた場合です。
・AppAckモードで動作させた場合、稀に MacAck より AppAck のエラー率が低く表示され
　る場合があります。Master側は MacAck は受信できなかったが、Slave側はパケットを
　正しく受信でき返送パケット送信に成功した場合などが考えられます。
・AppAckモードでは、送信間隔(Tick)を短く設定し MacAck 再送回数が多く設定されると、
　返信が時間内に間に合わずパケット送受信が混雑しエラー率が上昇します。Tick は、
　20ms 以上を推奨します。
・ビットエラー率は測定できません。

6. ライセンス
・提供されるソースコードの著作権・ライセンス条項は、ソースコードのコメントに記載
　しています。特に記載のないものは、モノワイヤレス株式会社が著作権を保有するものとし、
　その派生物を含めTWE(The Wireless Engine)シリーズでの利用に限定します。
・LCDには「美咲フォント」を使用させていただきました。有用なフォントについて感謝
　致します。
　http://www.geocities.jp/littlimi/misaki.htm

7. バージョン
  v2.06-1: 出力設定を追加, AppAck の判定を追加
  v2.05  : TWELITE での対応
  v2.04-2: libToCoNet の更新 (0.7.5) での再ビルドと確認
  v2.04-1: libToCoNet の更新 (0.4.1) に対応して再ビルド
  v2.03-1: libToCoNet のモジュール化の対応
    設定変更時の子機の再探索のエラー時に全子機再探索で行っていた点を、再度再探
    索するように改訂した。
  v2.02-1: 内部バージョン（カタカナ表記対応）
    SW4 を押しながら電源投入、直後に SW4 を離すことで、カタカナ表記で起動する。
    ※ ただし、文字ピクセル数の制限で可読性は良くありません。
  v2.01-1: ユーザインタフェースの見直しなど。
  v2.00-3: バグフィックス
    RfConfig でスタックリセットするようにした
    vProcessEvCoreStackNeighbourScanのRXイベント処理で0ポインタ参照していた
    Slave側の出力変更
    UART 'd' キーによるデバッグ出力の設定を行えるようにした
    ペイロード108バイト出力が動作していなかった
    EnergyScanバーグラフに MAX HOLD 機能を追加
    異常系の処理の追加 (送信処理中に中断された場合)
  v2.00-2: マイナーアップデート
    エナジースキャンによるチャネルエネルギーレベルを表示
    バーグラフのバックを空白から 50% ブロックに
    送信間隔に 33, 67ms を追加
  v2.00-1: LCD対応版初版
    LCD表示に対応
    子機の探索およびチャネル設定に対応
    ネットワークコードを分離した mac_evnthndr.c コードによるアプリケーション記述
  v1.00-*: プロトタイプ (UART操作限定, チャネル固定)

8. 判っている問題
  - ４台以上の子機があるとき４台目が表示されないことがある
  - CH18 が混信状態の時、子機探索出来ないことがある

　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　以上